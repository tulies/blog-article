## å‰è¨€

æœ¬æ–‡ä¸»è¦è®°å½•ä¸‹åœ¨MACä¸‹å¦‚ä½•æºç ç¼–è¯‘å®‰è£…php7.xï¼Œæœ¬æ–‡ä»¥php7.2ä¸ºä¾‹ï¼Œå…¶ä»–ç‰ˆæœ¬ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚linuxä¸‹çš„å®‰è£…æ­¥éª¤ä¹ŸåŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯æ²¡æœ‰MACä¸‹é‚£ä¹ˆå¤šå‘ã€‚

## å¼€å§‹å®‰è£…

### phpä¸‹è½½

é¦–å…ˆå»phpå®˜æ–¹ä¸‹è½½phpï¼Œä¸‹è½½åœ°å€ï¼šhttp://php.net/downloads.php  
æˆ‘ä»¬é€‰æ‹©ä¸‹è½½äº†ç›®å‰æœ€æ–°çš„ç‰ˆæœ¬ï¼Œphp-7.2.12.tar.gzã€‚ï¼ˆå…¶å®é€‰æ‹©å…¶ä»–ç‰ˆæœ¬å®‰è£…ï¼Œä¹Ÿéƒ½ç±»ä¼¼çš„æ“ä½œï¼‰


### phpå®‰è£…å‘½ä»¤

è§£å‹æºç å‹ç¼©åŒ…
```bash
tar -xvf php-7.2.12.tar.gz
```

è¿›å…¥è§£å‹åçš„æ–‡ä»¶å¤¹ä¾æ¬¡æ‰§è¡Œ `./configure` ã€ `make` ã€ `make install`

å…ˆè´´ä¸‹æˆ‘æœ€ç»ˆçš„è¾“å…¥æ‰§è¡Œçš„å‘½ä»¤ï¼Œåé¢å†å…·ä½“ä»‹ç»ã€‚ï¼ˆè‹¥æ˜¯æ–°æ‰‹ï¼Œä¸ç†è§£çš„è¯ä¸è¦ç›´æ¥è´´äº†å°±ç”¨ï¼Œå¯ä»¥çœ‹çœ‹æˆ‘ä¸‹é¢çš„è§£é‡Šä»¥åŠ `å®‰è£…è¿‡ç¨‹ä¸­å‡ºç°çš„é—®é¢˜` ,è‚¯å®šä¼šå¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œä¸ç„¶ä½ å¯èƒ½ä¼šèµ°ä¸é€šï¼‰

```bash
$ ./configure --prefix=/opt/php-7.2.12 \
--with-config-file-path=/opt/php-7.2.12/etc \
--enable-fpm \
--enable-mysqlnd \
--with-mysqli \
--with-pdo-mysql \
--with-freetype-dir \
--with-jpeg-dir \
--with-png-dir \
--with-libxml-dir \
--disable-rpath \
--enable-bcmath \
--enable-shmop \
--enable-sysvsem \
--enable-inline-optimization \
--enable-mbregex \
--with-mcrypt \
--enable-mbstring \
--enable-intl \
--enable-pcntl \
--enable-ftp \
--with-gd \
--with-mhash \
--enable-pcntl \
--enable-sockets \
--with-xmlrpc \
--enable-zip \
--enable-soap \
--disable-fileinfo \
--enable-opcache \
--with-xsl \
--with-openssl=/usr/local/opt/openssl \
--with-gettext=/usr/local/opt/gettext \
--with-zlib=/usr/local/opt/zlib \
--with-curl=/usr/local/opt/curl \
--with-iconv=/usr/local/opt/libiconv \
--with-icu-dir=/usr/local/opt/icu4c

$ make

$ sudo make install 
```

`--with-openssl`ã€`--with-zlib`ã€`--with-curl`ã€`--with-icu-dir` æŒ‡å®šäº†ä¾èµ–åŒ…æ‰€åœ¨çš„è·¯å¾„ï¼Œlinuxä¸‹ç›´æ¥ `yum install xxx` å®‰è£…çš„åŒ…é»˜è®¤æ˜¯æ”¾åœ¨ `/usr/local`ä¸‹çš„ã€‚å¯èƒ½éƒ½ä¸éœ€è¦æŒ‡å®šè·¯å¾„ã€‚

macä¸‹æˆ‘éƒ½æ˜¯é€šè¿‡ `brew` è¿›è¡Œå®‰è£…çš„ã€‚ å¦‚æ‰§è¡Œ `brew install curl` å°±å®Œæˆ `curl` ä¾èµ–åŒ…çš„å®‰è£…ã€‚

> é€šè¿‡ `brew` å®‰è£…çš„åŒ…ï¼Œéƒ½æ˜¯æ”¾åœ¨ `/usr/local/Cellar/` ä¸‹çš„ï¼ŒåŒæ—¶ä¹Ÿä¼šğŸ”—é“¾æ¥åˆ° `/usr/local/opt` ä¸‹é¢ã€‚ æ‰€ä»¥æˆ‘ä»¬ä¸Šé¢çš„æŒ‡å®šåŒ…æ‰€åœ¨è·¯å¾„ç”¨çš„éƒ½æ˜¯ `/usr/local/opt/curl` è¿™æ ·å­çš„ã€‚

## å®‰è£…è¿‡ç¨‹ä¸­å‡ºç°çš„é—®é¢˜

### configureæ—¶å‡ºç°çš„é—®é¢˜
å…¶å®å°±æ˜¯æ ¹æ® `configure` çš„æç¤ºï¼Œç¼ºä»€ä¹ˆä¾èµ–ï¼Œå°±è£…ä»€ä¹ˆï¼Œå¸¸è§çš„ä¸€äº›å¦‚ä¸‹ï¼š

```shell
configure: error: mcrypt.h not found. Please reinstall libmcrypt.

$ brew install libmcrypt
```

```
**$ brew install zlib** 
åœ¨./configure åé¢åŠ ä¸Š--with-zlib=/usr/local/opt/zlib
```

```
configure: error: Cannot find OpenSSL's <evp.h>  
$ brew install openssl
åœ¨./configure åé¢åŠ ä¸Š --with-openssl=/usr/local/opt/openssl
```

```
configure: error: jpeglib.h not found.  
$ brew install libjpeg
```

```
configure: error: png.h not found. 
$ brew install libpng
```

```
configure: error: freetype-config not found. 
$ brew install freetype
```

```
configure: error: Please reinstall the libcurl distribution -  
    easy.h should be in <curl-dir>/include/curl/ 
$ brew install curl
åœ¨./configure åé¢åŠ ä¸Š --with-curl=/usr/local/opt/curl
```

```
configure: error: Cannot locate header file libintl.h  
$ brew install gettext
MACä¸‹è¿™ä¸ªæ¯”è¾ƒç‰¹æ®Šï¼Œéœ€è¦ä¿®æ”¹ä¸‹ `configure` æ–‡ä»¶ï¼Œé€šè¿‡vimæˆ–å…¶ä»–ç¼–è¾‘å™¨æ‰“å¼€configureæ–‡ä»¶ï¼š  
å°†ï¼š`for i in $PHP_GETTEXT /usr/local /usr; do` 
ä¿®æ”¹ä¸º `for i in $PHP_GETTEXT /usr/local /usr /usr/local/opt/gettext; do`

æœ€æ–°å‘ç°ï¼š--with-gettext=/usr/local/opt/gettext å…¶å®æˆ‘åŠ ä¸Šè·¯å¾„å°±ä¸ä¼šæŠ¥é”™äº†ã€‚
```

```
configure: error: Please specify the install prefix of iconv with --with-iconv=<DIR>
brew install libiconv
åœ¨./configure åé¢åŠ ä¸Š --with-iconv=/usr/local/opt/libiconv
```

```
configure: error: Unable to detect ICU prefix or no failed. Please verify ICU install prefix and make sure icu-config works.
$ brew install icu4c
å½“åˆæè¿™ä¸ªçš„æ—¶å€™æ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºlinuxä¸‹ç›´æ¥ `yum -y install libicu-devel` å°±å¯ä»¥äº†ã€‚ macä¸‹æ˜¯icu4cï¼Œæ¯”è¾ƒç‰¹åˆ«ã€‚
```

### makeæ—¶å‡ºç°çš„é—®é¢˜

åœ¨makeæ—¶å¯èƒ½ä¼šå‡ºç°å¦‚ä¸‹æŠ¥é”™
```
Undefined symbols for architecture x86_64:
  "_libiconv", referenced from:
      _do_convert in gdkanji.o
      _zif_iconv_substr in iconv.o
      _zif_iconv_mime_encode in iconv.o
      _php_iconv_string in iconv.o
      __php_iconv_strlen in iconv.o
      __php_iconv_strpos in iconv.o
      __php_iconv_appendl in iconv.o
      ...
  "_libiconv_close", referenced from:
      _do_convert in gdkanji.o
      _zif_iconv_substr in iconv.o
      _zif_iconv_mime_encode in iconv.o
      _php_iconv_string in iconv.o
      __php_iconv_strlen in iconv.o
      __php_iconv_strpos in iconv.o
      __php_iconv_mime_decode in iconv.o
      ...
  "_libiconv_open", referenced from:
      _do_convert in gdkanji.o
      _zif_iconv_substr in iconv.o
      _zif_iconv_mime_encode in iconv.o
      _php_iconv_string in iconv.o
      __php_iconv_strlen in iconv.o
      __php_iconv_strpos in iconv.o
      __php_iconv_mime_decode in iconv.o
      ...
ld: symbol(s) not found for architecture x86_64
clang: error: linker command failed with exit code 1 (use -v to see invocation)
make: *** [sapi/cli/php] Error 1
```

ä½¿ç”¨ç¼–è¾‘å™¨æ‰“å¼€ `Makefile` æ–‡ä»¶ï¼Œæ‰¾åˆ° `EXTRA_LDFLAGS` è¿™ä¸€è¡Œï¼Œå¦‚ä¸‹è¿™æ ·ï¼š

```
EXTRA_LDFLAGS = -L/Library/Developer/CommandLineTools/SDKs/MacOSX10.14.sdk/usr/lib -L/usr/local/opt/openssl/lib -L/usr/local/opt/zlib/lib -L/usr/local/Cellar/curl/7.62.0/lib -L/usr/local/lib -L/usr/local/opt/freetype/lib -L/usr/local/opt/gettext/lib -L/usr/local/opt/libiconv/lib -L/usr/local/Cellar/icu4c/63.1/lib
EXTRA_LDFLAGS_PROGRAM = -L/Library/Developer/CommandLineTools/SDKs/MacOSX10.14.sdk/usr/lib -L/usr/local/opt/openssl/lib -L/usr/local/opt/zlib/lib -L/usr/local/Cellar/curl/7.62.0/lib -L/usr/local/lib -L/usr/local/opt/freetype/lib -L/usr/local/opt/gettext/lib -L/usr/local/opt/libiconv/lib -L/usr/local/Cellar/icu4c/63.1/lib
```

å»æ‰ `-L/Library/Developer/CommandLineTools/SDKs/MacOSX10.14.sdk/usr/lib` ç„¶åä¿å­˜æ–‡ä»¶ã€‚

ç„¶åé‡æ–°æ‰§è¡Œ `make`, ä½ å¯èƒ½éœ€è¦å…ˆæ‰§è¡Œä¸‹ `make clean` ã€‚

å®‰è£…æˆåŠŸåï¼ŒæŸ¥çœ‹phpçš„ç‰ˆæœ¬ï¼š
```bash
$ /opt/php-7.2.12/bin/php -v
PHP 7.2.12 (cli) (built: Nov 30 2018 02:52:18) ( NTS )
Copyright (c) 1997-2018 The PHP Group
Zend Engine v3.2.0, Copyright (c) 1998-2018 Zend Technologies
```

## å®‰è£…æˆåŠŸåçš„é…ç½®

é€šè¿‡ä¸Šé¢çš„æ“ä½œï¼Œä½ åº”è¯¥å·²ç»æˆåŠŸå®Œæˆäº†å®‰è£…ï¼Œphpè¢«å®‰è£…åœ¨`/opt/php-7.2.12`ä¸‹ã€‚ 

ä¸‹é¢å°±å·®æœ€åå‡ æ­¥äº†ï¼š

- å¤åˆ¶æºç åŒ…ä¸­çš„php.iniæ–‡ä»¶åˆ°å®‰è£…åçš„phpç›®å½•ä¸‹ã€‚å¼€å‘ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬å¤åˆ¶ `php.ini-development` å³å¯ã€‚

```
cp ./php.ini-development /opt/php-7.2.12/etc/php.ini
```

- æ–‡ä»¶ç›®å½•åˆ‡åˆ°å®‰è£…åçš„ç›®å½• `/opt/php-7.2.12`ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š

```bash
$ cp php-fpm.conf.default php-fpm.conf
$ cd php-fpm.d/www.conf.default php-fpm.d/www.conf
```

è‡³æ­¤ï¼Œåº”è¯¥å¯ä»¥å¯åŠ¨äº†ï¼Œæ‰§è¡Œå¯åŠ¨ `/opt/php-7.2.12/sbin/php-fpm` ï¼Œé»˜è®¤å¯åŠ¨ç«¯å£æ˜¯9000ã€‚

å¦‚æœä½ éœ€è¦æ›´æ”¹ä¸€äº›é…ç½®æˆ–ä¼˜åŒ–ï¼Œ ä½ å¯ä»¥å»ä¿®æ”¹ `/opt/php-7.2.12/etc/php.ini` å’Œ `/opt/php-7.2.12/etc/php-fpm.d/www.conf`

æœ¬åœ°å¼€å‘çš„è¯ï¼Œå°±é»˜è®¤é…ç½®é©¬é©¬è™è™ç”¨ç”¨å§ã€‚



## phpæ‰©å±•çš„å®‰è£…
ä¸‹é¢ä»¥phpredisæ‰©å±•å®‰è£…ä¸ºä¾‹ã€‚

phpredisä¸‹è½½åœ°å€ï¼šhttps://github.com/phpredis/phpredis  
ä¸‹è½½åï¼Œè§£å‹å¹¶è¿›å…¥æºç åŒ…

```
unzip phpredis-develop.zip
cd phpredis-develop
```

- ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆconfigureé…ç½®æ–‡ä»¶:
```
$ /opt/php-7.2.12/bin/phpize 
```

å¯èƒ½ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯æç¤ºï¼š
```
Cannot find autoconf. Please check your autoconf installation and the
$PHP_AUTOCONF environment variable. Then, rerun this script.
```
æ‰§è¡Œä¸‹ `brew install autoconf`

- ç¬¬äºŒæ­¥
```bash
$ ./configure --with-php-config=/opt/php-7.2.12/bin/php-config 
```


- ç¬¬ä¸‰æ­¥
```bash
$ make
```

- ç¬¬å››æ­¥
```bash
$ sudo make install
Installing shared extensions:     /opt/php-7.2.12/lib/php/extensions/no-debug-non-zts-20170718/
```
- ç¬¬äº”æ­¥
æ‰“å¼€ `php.ini` æ–‡ä»¶ï¼Œåœ¨æœ€ä¸‹é¢åŠ å…¥ï¼š
```
[redis]
extension_dir="/opt/php-7.2.12/lib/php/extensions/no-debug-non-zts-20170718/"
extension=redis.so
```

è‡³æ­¤ï¼Œå·²ç»å®Œæˆphpredisæ‰©å±•çš„å®‰è£…äº†ã€‚
æŸ¥çœ‹å·²å®‰è£…çš„æ‰©å±•ï¼š
```
$ /opt/php-7.2.12/bin/php -m
[PHP Modules]
bcmath
Core
ctype
curl
date
dom
filter
ftp
gd
gettext
hash
iconv
intl
json
libxml
mbstring
mcrypt
mysqli
mysqlnd
openssl
pcntl
pcre
PDO
pdo_mysql
pdo_sqlite
Phar
posix
redis
Reflection
session
shmop
SimpleXML
soap
sockets
SPL
sqlite3
standard
sysvsem
tokenizer
xml
xmlreader
xmlrpc
xmlwriter
xsl
zip
zlib

[Zend Modules]
```

